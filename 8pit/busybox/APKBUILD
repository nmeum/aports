# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=busybox
pkgver=1.26.0
pkgrel=1
pkgdesc="Size optimized toolbox of many common UNIX utilities"
url=http://busybox.net
arch="all"
license="GPL2"
makedepends_build=""
makedepends_host="linux-headers"
makedepends="$makedepends_build $makedepends_host"
install="$pkgname.post-install $pkgname.post-upgrade"
subpackages="$pkgname-static $pkgname-suid"
options="suid"
triggers="busybox.trigger=/bin:/usr/bin:/sbin:/usr/sbin:/lib/modules/*"
source="http://busybox.net/downloads/$pkgname-$pkgver.tar.bz2
	0001-ash-exec-busybox.static.patch
	0002-app-location-for-vi-and-lspci.patch
	0003-udhcpc-set-default-discover-retries-to-5.patch
	0004-ping-make-ping-work-without-root-privileges.patch
	0005-fbsplash-support-console-switching.patch
	0006-fbsplash-support-image-and-bar-alignment-and-positio.patch
	0007-depmod-support-generating-kmod-binary-index-files.patch
	0008-login-move-check_securetty-to-libbb.patch
	0009-libbb-allow_blank-argument-for-ask_and_check_passwor.patch
	0010-su-FEATURE_SU_NULLOK_SECURE.patch
	0011-ntpd-postpone-hostname-resolution-if-fails-on-startu.patch
	0012-diff-add-support-for-no-dereference.patch
	0013-syslogd-always-set-msg-timestamp-in-syslogd.patch

	acpid.logrotate
	busyboxconfig
	bbsuid.c
	nologin.c
	"

_sdir="$srcdir"/$pkgname-$pkgver
_staticdir="$srcdir"/build-static
_dyndir="$srcdir"/build-dynamic
_config="$srcdir"/busyboxconfig

prepare() {
	mkdir -p "$_staticdir" "$_dyndir"
	#patches
	cd "$_sdir"
	for i in $source; do
		local p=${i##*/}
		case $i in
		*.patch) msg $p; patch -p1 -i "$srcdir"/$p || return 1;;
		esac
	done

	cp "$srcdir"/nologin.c loginutils/
}

build() {
	# build bbsuid
	msg "Building bbsuid"
	${CC:-${CROSS_COMPILE}gcc} ${CPPFLAGS} ${CFLAGS} \
		${LDFLAGS} "$srcdir"/bbsuid.c -o "$_dyndir"/bbsuid || return 1

	# build dynamic
	cd "$_dyndir"
	msg "Building dynamic busybox"
	cp "$_config" .config
	[ "$CLIBC" = musl ] && sed -i \
		-e "s/CONFIG_EXTRA_COMPAT=y/CONFIG_EXTRA_COMPAT=n/" \
		.config
	make -C "$_sdir" O="$PWD" silentoldconfig || return 1
	make || return 1

	# build static
	cd "$_staticdir"
	msg "Building static busybox"
	sed -e "s/.*CONFIG_PIE.*/\# CONFIG_PIE is not set/" \
		-e "s/.*CONFIG_STATIC.*/CONFIG_STATIC=y/" \
		"$_config" > .config
	# musl does not support GNU regex
	[ "$CLIBC" = musl ] && sed -i \
		-e "s/CONFIG_EXTRA_COMPAT=y/CONFIG_EXTRA_COMPAT=n/" \
		.config
	make -C "$_sdir" O="$PWD" silentoldconfig || return 1
	make || return 1
	mv busybox busybox.static
}

package() {
	cd "$_dyndir"
	mkdir -p "$pkgdir"/usr/sbin "$pkgdir"/usr/bin "$pkgdir"/tmp \
		"$pkgdir"/var/cache/misc "$pkgdir"/bin "$pkgdir"/sbin
	chmod 1777 "$pkgdir"/tmp
	install -m755 busybox "$pkgdir"/bin/busybox || return 1
	# we need /bin/sh to be able to execute post-install
	ln -s /bin/busybox "$pkgdir"/bin/sh

	#ifupdown needs those dirs to be present
	mkdir -p \
		"$pkgdir"/etc/network/if-down.d \
		"$pkgdir"/etc/network/if-post-down.d \
		"$pkgdir"/etc/network/if-post-up.d \
		"$pkgdir"/etc/network/if-pre-down.d \
		"$pkgdir"/etc/network/if-pre-up.d \
		"$pkgdir"/etc/network/if-up.d \
		|| return 1

	install -Dm644 "$srcdir"/acpid.logrotate \
		"$pkgdir/etc/logrotate.d/acpid" || return 1

	mkdir -p "$pkgdir"/var/lib/udhcpd || return 1
	install -Dm644 "$_sdir"/examples/udhcp/udhcpd.conf \
		"$pkgdir"/etc/udhcpd.conf || return 1
	cat >"$pkgdir"/etc/securetty <<EOF
console
tty1
tty2
tty3
tty4
tty5
tty6
tty7
tty8
tty9
tty10
tty11
EOF
}

suid() {
	pkgdesc="suid binaries of Busybox"
	depends="${pkgname}"

	cd "$_dyndir"
	mkdir -p "$subpkgdir"/bin
	install -m4111 bbsuid "$subpkgdir"/bin/bbsuid || return 1
}

static() {
	pkgdesc="Statically linked Busybox"
	mkdir -p "$subpkgdir"/bin
	install -m755 "$_staticdir"/busybox.static \
		"$subpkgdir"/bin/busybox.static
}

md5sums="362acc60bd94343aa36d98beb1f0831f  busybox-1.26.0.tar.bz2
309e0efd6a0a05f048cfd3e137128771  0001-ash-exec-busybox.static.patch
47c1cbd3cdb6659fa7105104fe1b8f86  0002-app-location-for-vi-and-lspci.patch
559b88bf20a47b26ef01e6e6c317ccf1  0003-udhcpc-set-default-discover-retries-to-5.patch
3825531595bb40f545e8bfcbab50d107  0004-ping-make-ping-work-without-root-privileges.patch
6bb0fecdb6baada8ffe6828c2f86a985  0005-fbsplash-support-console-switching.patch
0e591c5f126d34949aa28cbe795f655b  0006-fbsplash-support-image-and-bar-alignment-and-positio.patch
849072a903e7a048d7c23312069ae4d9  0007-depmod-support-generating-kmod-binary-index-files.patch
882e7c5a3bdf1d72587fefa0a1879d28  0008-login-move-check_securetty-to-libbb.patch
179024c267636e6e112f30fd98b10cae  0009-libbb-allow_blank-argument-for-ask_and_check_passwor.patch
17dbe6b3071d71656e10621892ca9540  0010-su-FEATURE_SU_NULLOK_SECURE.patch
ff01463110cdd441412f4ac36a7016ab  0011-ntpd-postpone-hostname-resolution-if-fails-on-startu.patch
9e54851f5f447758b1f70a220c4ab4fa  0012-diff-add-support-for-no-dereference.patch
984d4ef85a2cf60c496e36a4b93fbd54  0013-syslogd-always-set-msg-timestamp-in-syslogd.patch
4046b78ee6a25259954797d73b94f4bd  acpid.logrotate
0e70be1c4acfeb5c61938afe8235d67e  busyboxconfig
378058009a1d6b1e321617b32b933e28  bbsuid.c
d64b58a30892c558bdbab7f0d0997577  nologin.c"
sha256sums="3ad227375ee870d529007f6ce83f173b8bd5a37df624ecb460295554261c0f4c  busybox-1.26.0.tar.bz2
3e64b23f688e794c8d76f102365e3e45510123644d2750ee7a0d8854ae89684e  0001-ash-exec-busybox.static.patch
51c6effb64ae51d855bcb341ae8229d10f388ae9067d1604f8b94053fc939051  0002-app-location-for-vi-and-lspci.patch
82a29ed25da3ff030f2dedd04fb548cc2a4560563f98509ef55cfe9c63d36f2c  0003-udhcpc-set-default-discover-retries-to-5.patch
dd4635fe56906d713eb0bf03348a058e5038eea2f7f64678235aebedd9f7791d  0004-ping-make-ping-work-without-root-privileges.patch
f15874495de7f9df9b185b37df7465fa3aabc72dfc4702758fee2cc7d506eab8  0005-fbsplash-support-console-switching.patch
f94cdbf9e1eebc75bc4c254c7934be38a9001a2bab2d7d40e8c050f69946651e  0006-fbsplash-support-image-and-bar-alignment-and-positio.patch
93e0efe8a5d7d2887515183f37b3a4795e34e6b99d6622989d9ee4df44257a04  0007-depmod-support-generating-kmod-binary-index-files.patch
2ec336c398dcf3f168c32492958c1b64c4953cd9cd192a2d4810e7f0b08b76b1  0008-login-move-check_securetty-to-libbb.patch
97bed6f0f033bbe4af0b317199544653376a9e1204edb07bd075d5d0fe80d01f  0009-libbb-allow_blank-argument-for-ask_and_check_passwor.patch
272b201b394b4770d37fb842623bddcecaa176ef2588839e735bbe5cd589c880  0010-su-FEATURE_SU_NULLOK_SECURE.patch
61d73467e357e805f66be9e68d202554d2830b25b1824c0aa357d1af641bcd53  0011-ntpd-postpone-hostname-resolution-if-fails-on-startu.patch
9dc746eeca6cf3f6637473a67f0e4ef3860d5500efaa17f4bbbfb1276b384cec  0012-diff-add-support-for-no-dereference.patch
36b0ce9f4d734768ddda3327ec47d36980a02959c56ad10dcb29518d701cd222  0013-syslogd-always-set-msg-timestamp-in-syslogd.patch
f7cbeb5a5a47395ad30454ce8262abcd3e91c33ef803c2ae31a9258d7142dd48  acpid.logrotate
4827a554f1f89d78b12bbf1583781619fcfee6c1814eb12a5e136c952aebc07e  busyboxconfig
52bd2c7c44779f910eedd2fea73ec0de520add400894cc132276587e25c73e39  bbsuid.c
9bbf0bec82e6d6907474958f3be048c54657fbf49207810b7e4d4d6146f0069d  nologin.c"
sha512sums="9e38c2f4c5ddb6c3a184170b5526c1a78cf53a575ed359fb18c407976cab9788fa95a26ca2d4e5c32e1d639890944d98e118149ee1402b18fe085b0baf0186d3  busybox-1.26.0.tar.bz2
8df024776debd48cdf3c146cdfa39b52adcd5cc3455b8b602652873e927d95d1a746eade41491ed4a8bec48883428b1994cbd3e67ebc2e03fd3f4863cd318d62  0001-ash-exec-busybox.static.patch
e691b8dd5a237dad38c38ac27692a8267a83bbd9df6d7df1401903a1d4c81e41ba51a0384a91595f330c2452f39c0aadff22e3eada47288554770f26bed6a8ad  0002-app-location-for-vi-and-lspci.patch
f979e60342ed5029f56304e2e47ca9010774590aa2b2739ec7c587d8cf761871492ba4f14d95761f37303322d244d1e22f12f06a383fa1cae794bae1a9e99199  0003-udhcpc-set-default-discover-retries-to-5.patch
97325d9040ecf20d7560d8d46f24679862f62562547337e5f69410aac7074389af39aa5426ba6c09f5645d377cfb9c5f9f045164160515c420d3447a00d73407  0004-ping-make-ping-work-without-root-privileges.patch
82cf363e599cfdce4f2c6676df852dd1ed726f7ce48ade3f0f3f2779db6db6da9583a5eaa8c8a3378f567be8c1439191ddbd119f998147cce7a097823aa2fc92  0005-fbsplash-support-console-switching.patch
34e0fe9bf95ae072034470d193791a7a62f1655998ab489885fcb232b8158643b9719edf127c8efeaee8e92b4844e65fe6406acea8c7179acc0242c04b476f36  0006-fbsplash-support-image-and-bar-alignment-and-positio.patch
5d4ff04479a6628fe3d266afc4bbac6f9943692ba8bc845f4a7ccde6df3a594e0341e918350f63b7bce78d4c621f4ab61ff9a8922f4bcf0793dec5a28b09d016  0007-depmod-support-generating-kmod-binary-index-files.patch
a056ba34611d2def8466269624a047d99bb65e76b25d75f044f8dea33ced43fe8ad5814923031ca5f7263809cacfa9f242737065f1fa4a958227a37a4dcbc85f  0008-login-move-check_securetty-to-libbb.patch
4cd0633ab088e2802de4b2eaa5a436ffd1478298ac3d6a187da615562bc8cccf29a461dbf1732e6a3ec2f76e16dae4602e0e2b76715f842d9ae19e290fa29457  0009-libbb-allow_blank-argument-for-ask_and_check_passwor.patch
80eab0ae98b8e0ddafc909673a66ad4275e7b379eedc49ac9301ad090e024043343d80f5ffe879e4161d9f0c44bd18df522bafd1f214122d3bc4cb47befeb430  0010-su-FEATURE_SU_NULLOK_SECURE.patch
b4c3216a454791c33d95dc939ff4673e3295250ff0f5903b0c99ed84b754a3d6c7a5f22653c42a1de2c2a674c17bfcd0b50a23c40d2f24f2fc832d84b6fe8fec  0011-ntpd-postpone-hostname-resolution-if-fails-on-startu.patch
0654699a626e97036baddd52b6bcd2deda92cd3609282f1cb8b5c326100a80fb5fa8947c18ea7608d878d1f538b42f295fc3356eb744903dd2fc97f23ccc4f55  0012-diff-add-support-for-no-dereference.patch
fed615e828e3abe5d61c17318112adc90de538e765601e609083c49208178d81dd06c53d080ad4b2542d47ad1f7e782f00385fbe3c5848976b147a3f1f6d3736  0013-syslogd-always-set-msg-timestamp-in-syslogd.patch
dadb4c953ebc755b88ee95c1489feb0c2d352f6e44abc716166024e6eea11ab9d10c84fad62c081775834d205cb04aa1be3c994676c88f4284495c54b9188e8b  acpid.logrotate
6cb68354c7a97657de285e75446c8116d05459d969e87879f7eb91aaf0b2d7d348c4f12996ac6c95d3094cbbbcd0024967c9e8057c40eb9e2d1f699ebdfa7c98  busyboxconfig
c1dd56509277c59751907a27f067f1622191ddfd498acfe390d83136d36a41f2bdfc2fd4daf35af77219a66fb00fea20483f34112afd5df2ccd9f36ab548e66f  bbsuid.c
4e7c291a70e879b74c0fc07c54a73ef50537d8be68fee6b2d409425c07afd2d67f9b6afcd8c33a7971014913cc5de85e45079681c9e77200c6cc2f34acfba6d2  nologin.c"
