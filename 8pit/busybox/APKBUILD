# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=busybox
pkgver=1.26.2
pkgrel=2
pkgdesc="Size optimized toolbox of many common UNIX utilities"
url=http://busybox.net
arch="all"
license="GPL2"
makedepends_build=""
makedepends_host="linux-headers"
makedepends="$makedepends_build $makedepends_host"
install="$pkgname.post-install $pkgname.post-upgrade"
subpackages="$pkgname-static $pkgname-suid"
options="suid"
triggers="busybox.trigger=/bin:/usr/bin:/sbin:/usr/sbin:/lib/modules/*"
source="http://busybox.net/downloads/$pkgname-$pkgver.tar.bz2
	0001-ash-exec-busybox.static.patch
	0002-app-location-for-vi-and-lspci.patch
	0003-udhcpc-set-default-discover-retries-to-5.patch
	0004-ping-make-ping-work-without-root-privileges.patch
	0005-fbsplash-support-console-switching.patch
	0006-fbsplash-support-image-and-bar-alignment-and-positio.patch
	0007-depmod-support-generating-kmod-binary-index-files.patch
	0008-login-move-check_securetty-to-libbb.patch
	0009-libbb-allow_blank-argument-for-ask_and_check_passwor.patch
	0010-su-FEATURE_SU_NULLOK_SECURE.patch
	0011-ntpd-postpone-hostname-resolution-if-fails-on-startu.patch
	0012-diff-add-support-for-no-dereference.patch
	0013-ash-make-shellexec-capable-of-using-separate-argv-0-.patch
	0014-ash-implement-exec-a-ARGV0-CMD-ARGV1.patch
	0015-syslogd-always-set-msg-timestamp-in-syslogd.patch

	location-for-cpio.patch

	acpid.logrotate
	busyboxconfig
	bbsuid.c
	nologin.c
	"

_sdir="$srcdir"/$pkgname-$pkgver
_staticdir="$srcdir"/build-static
_dyndir="$srcdir"/build-dynamic
_config="$srcdir"/busyboxconfig

prepare() {
	mkdir -p "$_staticdir" "$_dyndir"
	#patches
	cd "$_sdir"
	for i in $source; do
		local p=${i##*/}
		case $i in
		*.patch) msg $p; patch -p1 -i "$srcdir"/$p || return 1;;
		esac
	done

	cp "$srcdir"/nologin.c loginutils/
}

build() {
	# build bbsuid
	msg "Building bbsuid"
	${CC:-${CROSS_COMPILE}gcc} ${CPPFLAGS} ${CFLAGS} \
		${LDFLAGS} "$srcdir"/bbsuid.c -o "$_dyndir"/bbsuid || return 1

	# build dynamic
	cd "$_dyndir"
	msg "Building dynamic busybox"
	cp "$_config" .config
	[ "$CLIBC" = musl ] && sed -i \
		-e "s/CONFIG_EXTRA_COMPAT=y/CONFIG_EXTRA_COMPAT=n/" \
		.config
	make -C "$_sdir" O="$PWD" silentoldconfig || return 1
	make || return 1

	# build static
	cd "$_staticdir"
	msg "Building static busybox"
	sed -e "s/.*CONFIG_PIE.*/\# CONFIG_PIE is not set/" \
		-e "s/.*CONFIG_STATIC.*/CONFIG_STATIC=y/" \
		"$_config" > .config
	# musl does not support GNU regex
	[ "$CLIBC" = musl ] && sed -i \
		-e "s/CONFIG_EXTRA_COMPAT=y/CONFIG_EXTRA_COMPAT=n/" \
		.config
	make -C "$_sdir" O="$PWD" silentoldconfig || return 1
	make || return 1
	mv busybox busybox.static
}

package() {
	cd "$_dyndir"
	mkdir -p "$pkgdir"/usr/sbin "$pkgdir"/usr/bin "$pkgdir"/tmp \
		"$pkgdir"/var/cache/misc "$pkgdir"/bin "$pkgdir"/sbin
	chmod 1777 "$pkgdir"/tmp
	install -m755 busybox "$pkgdir"/bin/busybox || return 1
	# we need /bin/sh to be able to execute post-install
	ln -s /bin/busybox "$pkgdir"/bin/sh

	#ifupdown needs those dirs to be present
	mkdir -p \
		"$pkgdir"/etc/network/if-down.d \
		"$pkgdir"/etc/network/if-post-down.d \
		"$pkgdir"/etc/network/if-post-up.d \
		"$pkgdir"/etc/network/if-pre-down.d \
		"$pkgdir"/etc/network/if-pre-up.d \
		"$pkgdir"/etc/network/if-up.d \
		|| return 1

	install -Dm644 "$srcdir"/acpid.logrotate \
		"$pkgdir/etc/logrotate.d/acpid" || return 1

	mkdir -p "$pkgdir"/var/lib/udhcpd || return 1
	install -Dm644 "$_sdir"/examples/udhcp/udhcpd.conf \
		"$pkgdir"/etc/udhcpd.conf || return 1
	cat >"$pkgdir"/etc/securetty <<EOF
console
tty1
tty2
tty3
tty4
tty5
tty6
tty7
tty8
tty9
tty10
tty11
EOF
}

suid() {
	pkgdesc="suid binaries of Busybox"
	depends="${pkgname}"

	cd "$_dyndir"
	mkdir -p "$subpkgdir"/bin
	install -m4111 bbsuid "$subpkgdir"/bin/bbsuid || return 1
}

static() {
	pkgdesc="Statically linked Busybox"
	mkdir -p "$subpkgdir"/bin
	install -m755 "$_staticdir"/busybox.static \
		"$subpkgdir"/bin/busybox.static
}

sha512sums="9926d211d0b4f34b513d934d7b111ebbf933c2dc31206bdd80426a62d47d5b1475b70bec5aaa14a26b94a202ab1465d994062a002750a312dcb8167096eb3719  busybox-1.26.2.tar.bz2
8df024776debd48cdf3c146cdfa39b52adcd5cc3455b8b602652873e927d95d1a746eade41491ed4a8bec48883428b1994cbd3e67ebc2e03fd3f4863cd318d62  0001-ash-exec-busybox.static.patch
e691b8dd5a237dad38c38ac27692a8267a83bbd9df6d7df1401903a1d4c81e41ba51a0384a91595f330c2452f39c0aadff22e3eada47288554770f26bed6a8ad  0002-app-location-for-vi-and-lspci.patch
f979e60342ed5029f56304e2e47ca9010774590aa2b2739ec7c587d8cf761871492ba4f14d95761f37303322d244d1e22f12f06a383fa1cae794bae1a9e99199  0003-udhcpc-set-default-discover-retries-to-5.patch
97325d9040ecf20d7560d8d46f24679862f62562547337e5f69410aac7074389af39aa5426ba6c09f5645d377cfb9c5f9f045164160515c420d3447a00d73407  0004-ping-make-ping-work-without-root-privileges.patch
82cf363e599cfdce4f2c6676df852dd1ed726f7ce48ade3f0f3f2779db6db6da9583a5eaa8c8a3378f567be8c1439191ddbd119f998147cce7a097823aa2fc92  0005-fbsplash-support-console-switching.patch
34e0fe9bf95ae072034470d193791a7a62f1655998ab489885fcb232b8158643b9719edf127c8efeaee8e92b4844e65fe6406acea8c7179acc0242c04b476f36  0006-fbsplash-support-image-and-bar-alignment-and-positio.patch
5d4ff04479a6628fe3d266afc4bbac6f9943692ba8bc845f4a7ccde6df3a594e0341e918350f63b7bce78d4c621f4ab61ff9a8922f4bcf0793dec5a28b09d016  0007-depmod-support-generating-kmod-binary-index-files.patch
a056ba34611d2def8466269624a047d99bb65e76b25d75f044f8dea33ced43fe8ad5814923031ca5f7263809cacfa9f242737065f1fa4a958227a37a4dcbc85f  0008-login-move-check_securetty-to-libbb.patch
4cd0633ab088e2802de4b2eaa5a436ffd1478298ac3d6a187da615562bc8cccf29a461dbf1732e6a3ec2f76e16dae4602e0e2b76715f842d9ae19e290fa29457  0009-libbb-allow_blank-argument-for-ask_and_check_passwor.patch
80eab0ae98b8e0ddafc909673a66ad4275e7b379eedc49ac9301ad090e024043343d80f5ffe879e4161d9f0c44bd18df522bafd1f214122d3bc4cb47befeb430  0010-su-FEATURE_SU_NULLOK_SECURE.patch
b4c3216a454791c33d95dc939ff4673e3295250ff0f5903b0c99ed84b754a3d6c7a5f22653c42a1de2c2a674c17bfcd0b50a23c40d2f24f2fc832d84b6fe8fec  0011-ntpd-postpone-hostname-resolution-if-fails-on-startu.patch
0654699a626e97036baddd52b6bcd2deda92cd3609282f1cb8b5c326100a80fb5fa8947c18ea7608d878d1f538b42f295fc3356eb744903dd2fc97f23ccc4f55  0012-diff-add-support-for-no-dereference.patch
bf3e7c400e718fbc19fda19d7304ed938e5c59f45d5d1ba6eafd8f62a984d40419dbefd9f6840ac7f220d00abfae67e8f31be78b4c2e25310b265bca8beb91a2  0013-ash-make-shellexec-capable-of-using-separate-argv-0-.patch
cb7aa4d5d22596bc8c6510cb653599dd8cf4c3a5312e93adfc6411d811376db2ad3b506a111322f46aa9929a5337e22a169da4ea250fd4b39e703adbc8792a2d  0014-ash-implement-exec-a-ARGV0-CMD-ARGV1.patch
fed615e828e3abe5d61c17318112adc90de538e765601e609083c49208178d81dd06c53d080ad4b2542d47ad1f7e782f00385fbe3c5848976b147a3f1f6d3736  0015-syslogd-always-set-msg-timestamp-in-syslogd.patch
f26e090f5de0096ba5c4d46989ebe0ab5fa64c8bf54cd37ddec302fddfde23eac914858d86cc52bf3b5780a8e81ea2612ef6e713df2828e52c606f86a6816f39  location-for-cpio.patch
dadb4c953ebc755b88ee95c1489feb0c2d352f6e44abc716166024e6eea11ab9d10c84fad62c081775834d205cb04aa1be3c994676c88f4284495c54b9188e8b  acpid.logrotate
d4b9f4a09dcf08ec9f7a66c5250465e3a6dd9beb15140a462a1464110824426c732399e4dab4e6a33073626d4db0e76085b218cd0521027e57ce9f918ff1af29  busyboxconfig
c1dd56509277c59751907a27f067f1622191ddfd498acfe390d83136d36a41f2bdfc2fd4daf35af77219a66fb00fea20483f34112afd5df2ccd9f36ab548e66f  bbsuid.c
4e7c291a70e879b74c0fc07c54a73ef50537d8be68fee6b2d409425c07afd2d67f9b6afcd8c33a7971014913cc5de85e45079681c9e77200c6cc2f34acfba6d2  nologin.c"
