# Maintainer:  Natanael Copa <ncopa@alpinelinux.org>
pkgname=mdocml
pkgver=1.13.4
pkgrel=1
pkgdesc="mdoc/man compiler"
url="http://mdocml.bsd.lv/"
arch="all"
license="BSD"
depends=""
makedepends="sqlite-dev zlib-dev"
install="$pkgname.post-deinstall"
subpackages="$pkgname-doc $pkgname-dev man $pkgname-apropos $pkgname-soelim"
source="http://mdocml.bsd.lv/snapshots/$pkgname-$pkgver.tar.gz
	shared-libmandoc.patch
	pager.patch
	man.conf
	$pkgname.cron
	"

builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	default_prepare || return 1
	cd "$builddir"
	cat >configure.local<<EOF
PREFIX=/usr
MANDIR=/usr/share/man
LIBDIR=/usr/lib
CFLAGS="$CFLAGS"
HAVE_SQLITE3=1
HAVE_SQLITE3_ERRSTR=1
EOF
}

build() {
	cd "$builddir"
	./configure || return 1
	make || return 1
}

package() {
	cd "$builddir"
	make -j1 DESTDIR="$pkgdir" base-install db-install || return 1
	install -Dm644 "$srcdir"/man.conf "$pkgdir"/etc/man.conf || return 1
	for X in usr/bin/apropos usr/bin/whatis usr/bin/man usr/sbin/makewhatis
		do
			rm -f "$pkgdir/$X" || return 1
			ln -s /usr/bin/mandoc "$pkgdir/$X" || return 1
		done
}

man() {
	arch="noarch"
	pkgdesc="dummy package for upgrade compatibility.  this can safely be removed"
	depends="mdocml"
	mkdir -p "$subpkgdir"
}

apropos() {
	pkgdesc="makewhatis/whatis and apropos tools and index"
	mkdir -p "$subpkgdir"/usr/sbin "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/apropos \
		"$pkgdir"/usr/bin/whatis \
		"$subpkgdir"/usr/bin/ || return 1
	mv "$pkgdir"/usr/sbin/makewhatis \
		"$subpkgdir"/usr/sbin/ || return 1
	install -Dm755 "$srcdir"/$pkgname.cron \
		"$subpkgdir"/etc/periodic/daily/makewhatis || return 1
}

soelim() {
	pkgdesc="so elimination tool"
	depends=""
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/soelim \
		"$subpkgdir"/usr/bin/ || return 1
}

md5sums="797d4f0e112479f8861e03a72f8b8b01  mdocml-1.13.4.tar.gz
07aff0e8b4766aa22bddc2969aa158cf  shared-libmandoc.patch
1b7b756e3a996f146971785bd3aeede5  pager.patch
6e893bef0cf680eec807b230e6619d27  man.conf
9eacde69649cea3d8523efa7987427d7  mdocml.cron"
sha256sums="0a55c1addb188071d6f784599303656b8465e98ec6b2f4f264e12fb96d79e0ef  mdocml-1.13.4.tar.gz
b4d3498a831fb840447ece0662b0f97831dc147cfb19d3ffbb55ce0fdd9d8763  shared-libmandoc.patch
b1a94bc58655934f9356dcbdf16847fbbd30b2863b1e54b87721442e88ae6d0d  pager.patch
3381c6ceb99e7db1404fdb44419040c3b441a251d594292e53545b5e4e378e2b  man.conf
bdc5669983f3daf1e067fe1489cb60e5a4e9a34e0c29af7dfa9b3cc35867a02b  mdocml.cron"
sha512sums="1d671651ca1bb81d0de86e34de8b95a3bde5b335bda03d1b83b601e26eed167af6ef8bac6f9935603e57514f2734cd8f979ed556c76db629dd5c685892d71ec2  mdocml-1.13.4.tar.gz
3900787215c7b44fd731bb34a2678a99c54396f27a14d15ad7a0a7483a2a1882be701b26aa7fe56805879d1cb127877453ba5b0ef87df68e435be0053d1200b6  shared-libmandoc.patch
04947a275df99298591c2a46fb81b74c7c3fcb9f3cf8fb718cf1e32eeae5409e90a3bca89e542f8aa1b30792e837fd3d716303a636d1a3ec165fbb9529546a64  pager.patch
0723c32ab70e5b1c77768ca78d7437b26bed19b90b27876b10cc463359c41332befc0105fc1e23ceae48de5a892f1aa7ac60ef7eb0b6b8f1616726c4300632fe  man.conf
be521c33e95bfa78bd086adab423bda5239eca90cc028770da4382c2074d4b4c9d8cf12dfb9d2527dff85a199e092a79ea765dbaf059ca7d0272f364fd690362  mdocml.cron"
