# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=unbound
pkgver=1.6.5
pkgrel=1
pkgdesc="Unbound is a validating, recursive, and caching DNS resolver"
pkgusers="unbound"
pkggroups="unbound"
url="http://unbound.net/"
arch="all"
license="BSD"
depends="dnssec-root"
depends_dev="libressl-dev expat-dev ldns-dev libevent-dev"
makedepends="$depends_dev python2-dev swig linux-headers"
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-libs $pkgname-dbg py-unbound:py $pkgname-migrate::noarch"
source="http://unbound.net/downloads/unbound-$pkgver.tar.gz
	conf.patch
	migrate-dnscache-to-unbound
	unbound.initd"
builddir="$srcdir"/$pkgname-$pkgver

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--with-username=unbound \
		--with-run-dir="" \
		--with-pidfile=/var/run/unbound/unbound.pid \
		--with-rootkey-file=/usr/share/dnssec-root/trusted-key.key \
		--with-libevent \
		--with-ldns \
		--with-pthreads \
		--disable-static \
		--disable-rpath \
		--with-ssl \
		--without-pythonmodule \
		--with-pyunbound

	# do not link to libpython
	sed -e '/^LIBS=/s/-lpython.*[[:space:]]/ /' \
		-i Makefile

	make
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install
	install -D contrib/update-anchor.sh \
		"$pkgdir"/usr/share/$pkgname/update-anchor.sh

	install -m755 -D "$srcdir"/unbound.initd \
		"$pkgdir"/etc/init.d/unbound
	install -d -o unbound -g unbound "$pkgdir"/var/run/unbound

	mkdir -p "$pkgdir"/usr/share/doc/$pkgname/
	install -m644 doc/CREDITS doc/Changelog doc/FEATURES \
		doc/README doc/TODO "$pkgdir"/usr/share/doc/$pkgname/
}

libs() {
	pkgdesc="unbound shared libraries"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/lib*.so.* "$subpkgdir"/usr/lib/
}

py() {
	pkgdesc="Python bindings to libunbound"
	mkdir -p "$subpkgdir"/usr/lib/
	mv "$pkgdir"/usr/lib/python* "$subpkgdir"/usr/lib/
}

migrate() {
	pkgdesc="Simple tool to migrate from dnscache to unbound"
	mkdir -p "$subpkgdir"/usr/bin/
	install -m755 "$srcdir"/migrate-dnscache-to-unbound \
		"$subpkgdir"/usr/bin/
}

sha512sums="7a3fa54ca0c210ff3d45cdf22c8861f67e46c23133afeeaf85126c70d68515b931a61c82c44eea73318e1ab4e2c7cf0dc0650599ff4145804f51435579c5682c  unbound-1.6.5.tar.gz
8726f9450a7aa753e751971c293fed945e08bc5c7928ab03ac35724015c11773c95e07eb9077ff4eceae6e383dfc6ea37e9c55d20afa0d6183e20d99d4380091  conf.patch
b26a13c1c88da9611a65705dc59f7233c5e0f6aced0d7d66c18536a969a2de627ca5d4bb55eedd81f2f040fa11bde48eaaeca2850f376e72e7a531678a259131  migrate-dnscache-to-unbound
540e7a11fa5421e2d103c42d69faf1ba005adcadfac2f65091795a2f00e5b5acd1436b4d2adfe2bb0fdfcbfb44d0967d6bce87620c618549fcd7e32019040f29  unbound.initd"
