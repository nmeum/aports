# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=vim
pkgver=8.0.0460
pkgrel=1
pkgdesc="advanced text editor"
url="http://www.vim.org"
arch="all"
license="custom"
depends=""
makedepends="ncurses-dev libxt-dev"
subpackages="$pkgname-doc ${pkgname}diff::noarch"
source="$pkgname-$pkgver.tar.gz::https://github.com/$pkgname/$pkgname/archive/v$pkgver.tar.gz
	vimrc
	CVE-2017-5953.patch
	"
builddir="$srcdir/$pkgname-$pkgver"

# secfixes:
#   8.0.0329-r0:
#     - CVE-2017-5953
#   8.0.0056-r0:
#     - CVE-2016-1248

prepare() {
	cd "$builddir"
	# Read vimrc from /etc/vim
	echo '#define SYS_VIMRC_FILE "/etc/vim/vimrc"' >> src/feature.h
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--with-features=normal \
		--with-x=yes \
		--disable-nls \
		--enable-multibyte \
		--enable-gui=no \
		--with-compiledby="Alpine Linux" \
		|| return 1
	make || return 1
}

package() {
	cd "$builddir"
	make -j1 DESTDIR="$pkgdir/" install

	install -Dm644 runtime/doc/uganda.txt \
		"$pkgdir/usr/share/licenses/$pkgname/LICENSE" || return 1
	install -Dm644 "$srcdir"/vimrc "$pkgdir"/etc/vim/vimrc || return 1
}

vimdiff() {
	pkgdesc="view file diffs in vim"
	depends="diffutils"

	install -d "$subpkgdir"/usr/bin || return 1
	mv "$pkgdir"/usr/bin/vimdiff "$subpkgdir"/usr/bin
}

sha512sums="a73b82304affc6fb32fd3ed603b44de1a19da4a4213bf2b9a1a16b09d4ec9efe59b5c9ae8f8651a2a030206d2200ca4d6dfc4a42d49750369cc207e37401e934  vim-8.0.0460.tar.gz
d9586b777881973cb5e48e18750336a522ed72c3127b2d6b6991e2b943468ca5b694476e7fa39ab469178c1375fc8f52627484e0fe377aea5811a513e35a7b02  vimrc
f8dbe8e64646a785715293dcabba95f71107dd591d4e9e178b8d40884c7b9946da04a93bf0d52ca63a3da96e8fce79d5909e983d57f8cf061c7e14b9ea14c271  CVE-2017-5953.patch"
